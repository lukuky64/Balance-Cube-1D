<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32-S3 Balancing Square</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>

<body>
    <h2>ESP32-S3 Balancing Square Visualization</h2>
    <p>Status: <span id="status">Disconnected</span></p>

    <script>
        let scene, camera, renderer, square, group;

        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // Create a group to control rotation about the corner
            group = new THREE.Group();

            // Create the square
            const geometry = new THREE.BoxGeometry(3, 3, 0.001); // Thin rectangle
            const material = new THREE.MeshBasicMaterial({ color: 0xff4d6d, wireframe: false });
            square = new THREE.Mesh(geometry, material);

            // Offset the square so its bottom-left cor ner is at (0,0)
            square.position.set(1.5, 1.5, 0);  // ðŸ”¹ Moves the pivot to a corner

            // Add square to the group
            group.add(square);
            scene.add(group);

            // Add a floor (a static rectangle beneath the square)
            const floorGeometry = new THREE.PlaneGeometry(20, 0.5);  // Wide rectangle
            const floorMaterial = new THREE.MeshBasicMaterial({ color: 0xffffff });  // Gray color
            const floor = new THREE.Mesh(floorGeometry, floorMaterial);

            // Position the floor slightly below the square
            floor.position.set(0, -0.25, 0);  // Adjust height as needed

            // Add the floor to the scene (not in the group)
            scene.add(floor);

            camera.position.set(0, 2, 5);
            camera.lookAt(0, 2, 0);

            animate();
        }

        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }

        // WebSocket connection to ESP32-S3
        const ws = new WebSocket('ws://192.168.4.1:8080');

        ws.onopen = function () {
            document.getElementById("status").innerText = "Connected";
        };

        ws.onmessage = function (event) {
            let data;
            try {
                data = JSON.parse(event.data);
                angle = data.angle;
            } catch (error) {
                angle = parseFloat(event.data);
            }

            // Apply rotation to the group (which rotates the square around its corner)
            group.rotation.z = Math.PI / 4 + angle;
        };

        ws.onclose = function () {
            document.getElementById("status").innerText = "Disconnected";
        };

        init();
    </script>
</body>

</html>